services:
  app_proxy:
    environment:
      APP_HOST: zot24-openclaw_setup_1
      APP_PORT: 8080

  setup:
    image: ghcr.io/zot24/openclaw-setup:v1.1.0@sha256:60f493209d01dd72a1dbc170f9375d469f9f06077d60dcfa1ef1a03ea5274c2a
    restart: on-failure
    # Security hardening: minimize blast radius of Docker socket access
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp
    volumes:
      - ${APP_DATA_DIR}/data:/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      UPSTREAM_HOST: zot24-openclaw_web_1
      UPSTREAM_PORT: "28639"
      CONFIG_DIR: /config
      WEB_CONTAINER: zot24-openclaw_web_1

  web:
    image: ghcr.io/zot24/openclaw-docker:v2026.2.19@sha256:6c5cc75e9e241f204a9cf4421dabc14c6d2d5d4eb585699795ecb097d47c53ea
    # Note: No user directive - container starts as root, entrypoint fixes
    # volume permissions then drops to openclaw user (UID 1000)
    restart: on-failure
    stop_grace_period: 1m
    depends_on:
      - setup
    volumes:
      - ${APP_DATA_DIR}/data:/home/openclaw/.openclaw
      - ${APP_DATA_DIR}/workspace:/home/openclaw/clawd
    env_file:
      - path: ${APP_DATA_DIR}/data/openclaw.env
        required: false
    environment:
      # Ensure HOME is set correctly (Umbrel may override)
      HOME: /home/openclaw
      # Gateway configuration (WebChat UI served at /chat on gateway port)
      OPENCLAW_GATEWAY_PORT: 28639
      # Bind to all interfaces so other containers can reach the gateway
      OPENCLAW_GATEWAY_HOST: "0.0.0.0"
      # Data directories
      OPENCLAW_DATA_DIR: /home/openclaw/.openclaw
      OPENCLAW_WORKSPACE: /home/openclaw/clawd
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:28639/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
