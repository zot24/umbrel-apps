version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: zot24-openclaw_setup_1
      APP_PORT: 8080

  setup:
    image: node:20-alpine
    restart: on-failure
    command: ["node", "/app/server.js"]
    volumes:
      - ./setup/server.js:/app/server.js:ro
      - ./setup/wizard.html:/app/wizard.html:ro
      - ${APP_DATA_DIR}/data:/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      UPSTREAM_HOST: zot24-openclaw_web_1
      UPSTREAM_PORT: "28639"
      CONFIG_DIR: /config
      WEB_CONTAINER: zot24-openclaw_web_1

  web:
    image: ghcr.io/zot24/openclaw-docker:v2026.2.9
    # Note: No user directive - container starts as root, entrypoint fixes
    # volume permissions then drops to openclaw user (UID 1000)
    restart: on-failure
    stop_grace_period: 1m
    depends_on:
      - setup
    volumes:
      - ${APP_DATA_DIR}/data:/home/openclaw/.openclaw
      - ${APP_DATA_DIR}/workspace:/home/openclaw/clawd
    env_file:
      - ${APP_DATA_DIR}/data/openclaw.env
    environment:
      # Ensure HOME is set correctly (Umbrel may override)
      HOME: /home/openclaw
      # Gateway configuration (WebChat UI served at /chat on gateway port)
      OPENCLAW_GATEWAY_PORT: 28639
      # Re-generate config from env vars on restart
      OPENCLAW_REGEN_CONFIG: "true"
      # Data directories
      OPENCLAW_DATA_DIR: /home/openclaw/.openclaw
      OPENCLAW_WORKSPACE: /home/openclaw/clawd
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:28639/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
